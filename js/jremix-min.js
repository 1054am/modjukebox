function createJRemixer(e,t){function i(e){return"start"in e&&"duration"in e}function s(e){return"getChannelData"in e}function o(e){if(false){console.log(e)}}var n=t;var r={remixTrackById:function(e,t){var i="http://labs.echonest.com/Uploader/profile?callback=?";n.getJSON(i,{trid:trid},function(e){if(e.response.status.code==0){r.remixTrack(e.response.track,t)}})},remixTrack:function(t,n){function r(r){var i=new XMLHttpRequest;o("fetchAudio "+r);t.buffer=null;i.open("GET",r,true);i.responseType="arraybuffer";this.request=i;i.onload=function(){o("audio loaded");if(false){t.buffer=e.createBuffer(i.response,false);t.status="ok";n(1,t,100)}else{e.decodeAudioData(i.response,function(e){t.buffer=e;t.status="ok";n(1,t,100)},function(e){t.status="error: loading audio";n(-1,t,0);console.log("audio error",e)})}};i.onerror=function(e){o("error loading loaded");t.status="error: loading audio";n(-1,t,0)};i.onprogress=function(e){var r=Math.round(e.position*100/e.totalSize);n(0,t,r)};i.send()}function i(e){o("preprocessTrack");var t=["sections","bars","beats","tatums","segments"];for(var n in t){var r=t[n];o("preprocessTrack "+r);for(var i in e.analysis[r]){var u=e.analysis[r];i=parseInt(i);var c=u[i];c.track=e;c.which=i;if(i>0){c.prev=u[i-1]}else{c.prev=null}if(i<u.length-1){c.next=u[i+1]}else{c.next=null}}}a(e,"sections","bars");a(e,"bars","beats");a(e,"beats","tatums");a(e,"tatums","segments");f(e,"bars");f(e,"beats");f(e,"tatums");l(e,"bars");l(e,"beats");l(e,"tatums");s(e)}function s(e){var t=.3;var n=[];n.push(e.analysis.segments[0]);for(var r=1;r<e.analysis.segments.length;r++){var i=e.analysis.segments[r];var s=n[n.length-1];if(u(i,s)&&i.confidence<t){n[n.length-1].duration+=i.duration}else{n.push(i)}}e.analysis.fsegments=n}function u(e,t){var n=1;var r=timbral_distance(e,t);return r<n}function a(e,t,n){var r=0;var i=e.analysis[t];var s=e.analysis[n];for(var o in i){var u=i[o];u.children=[];for(var a=r;a<s.length;a++){var f=s[a];if(f.start>=u.start&&f.start<u.start+u.duration){f.parent=u;f.indexInParent=u.children.length;u.children.push(f);r=a}else if(f.start>u.start){break}}}}function f(e,t){var n=0;var r=e.analysis[t];var i=e.analysis.segments;for(var s=0;s<r.length;s++){var o=r[s];for(var u=n;u<i.length;u++){var a=i[u];if(a.start>=o.start){o.oseg=a;n=u;break}}}}function l(e,t){var n=0;var r=e.analysis[t];var i=e.analysis.segments;for(var s=0;s<r.length;s++){var o=r[s];o.overlappingSegments=[];for(var u=n;u<i.length;u++){var a=i[u];if(a.start+a.duration<o.start){continue}if(a.start>o.start+o.duration){break}n=u;o.overlappingSegments.push(a)}}}if(t.status=="complete"){i(t);r(t.info.url)}else{t.status="error: incomplete analysis";n(false,t)}},getPlayer:function(){function a(t,o){r.gain.value=1;if(s(o)){var u=e.createBufferSource();u.buffer=o;u.connect(r);u.start(t);return t}else if(n.isArray(o)){for(var f in o){t=a(t,o[f])}return t}else if(i(o)){var u=e.createBufferSource();u.buffer=o.track.buffer;u.connect(r);u.start(t,o.start,o.duration);o.audioSource=u;return t+o.duration}else{l("can't play "+o);return t}}function f(t,n){var i=e.currentTime;var s=t==0?i:t;var a=s+n.duration;if(u&&u.track===n.track&&u.which+1==n.which){}else{var f=e.createBufferSource();r.gain.value=1;f.buffer=n.track.buffer;f.connect(r);var l=track.audio_summary.duration-n.start;f.start(s,n.start,l);if(o){o.stop(s)}o=f}n.audioSource=o;u=n;return a}function l(e){console.log(e)}var t=0;var r=e.createGain();var o=null;var u=null;r.gain.value=1;r.connect(e.destination);var c={play:function(e,t){return f(e,t)},playNow:function(e){a(0,e)},addCallback:function(e){},queue:function(n){var r=e.currentTime;if(r>t){t=r}t=a(t,n)},queueRest:function(e){t+=e},stop:function(e){if(e===undefined){if(o){o.stop(0);o=null}}else{if("audioSource"in e){if(e.audioSource!=null){e.audioSource.stop(0)}}}u=null},curTime:function(){return e.currentTime}};return c},fetchSound:function(t,n){var r=new XMLHttpRequest;o("fetchSound "+t);r.open("GET",t,true);r.responseType="arraybuffer";this.request=r;r.onload=function(){var t=e.createBuffer(r.response,false);n(true,t)};r.onerror=function(e){n(false,null)};r.send()}};return r}function euclidean_distance(e,t){var n=0;for(var r=0;r<3;r++){var i=t[r]-e[r];n+=i*i}return Math.sqrt(n)}function timbral_distance(e,t){return euclidean_distance(e.timbre,t.timbre)}function clusterSegments(e,t,n,r){function u(e){var t=[];for(var n=0;n<e;n++){t.push(0)}return t}function a(){var n=u(t);for(var r=0;r<e.analysis.segments.length;r++){var i=e.analysis.segments[r][s];n[i]++}for(var r=0;r<n.length;r++){}}function f(e,t){for(var n=0;n<e.length;n++){e[n]+=t[n]}return e}function l(e,t){for(var n=0;n<e.length;n++){e[n]/=t}return e}function c(t){var n=0;var r=e.analysis.segments;var o=u(r[0][i].length);for(var a=0;a<r.length;a++){if(r[a][s]===t){n++;o=f(o,r[a][i])}}o=l(o,n);return o}function h(e,t){var n=Number.MAX_VALUE;var r=-1;for(var s=0;s<e.length;s++){var o=euclidean_distance(e[s],t[i]);if(o<n){n=o;r=s}}return r}var i=r||"timbre";var s=n||"cluster";var o=1e3;for(var p=0;p<e.analysis.segments.length;p++){e.analysis.segments[p][s]=Math.floor(Math.random()*t)}a();while(o-->0){var d=[];for(var p=0;p<t;p++){d[p]=c(p)}var v=0;for(var p=0;p<e.analysis.segments.length;p++){var m=e.analysis.segments[p];var g=m[s];var y=h(d,m);if(g!==y){v++;m[s]=y}}if(v==0){break}}a()}