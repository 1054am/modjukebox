// This code will make you cry. It was written in a mad 
// dash during Music Hack Day Boston 2012, and has
// quite a bit of hackage of the bad kind in it.
function info(e){$("#info").text(e)}function error(e){if(e.length==0){$("#error").hide()}else{$("#error").text(e);$("#error").show()}}function setDisplayMode(e){if(e){$("#song-div").hide();$("#select-track").hide();$("#running").show();$(".rotate").hide()}else{listPopularTracks();$("#song-div").show();$("#select-track").show();$("#running").hide();$(".rotate").show()}info("")}function hideAll(){$("#song-div").hide();$("#select-track").hide();$("#running").hide();$(".rotate").hide()}function stop(){player.stop();player=remixer.getPlayer()}function createTiles(e){return createTileCircle(e,420)}function createTileCircle(e,t){var n=now();var r=0;var i=18;var s=90;var o=[];var u=track.analysis[e];var a=u.length;var f=t;var l=Math.PI*2/a;var c=2*f;var h=c/a;var p=h*70;var d=-Math.PI/2;if(p>s){p=s}paper.clear();var v=d;for(var m=0;m<u.length;m++){var g=createNewTile(m,u[m],p,h);var y=r+f;var b=i+2*f/u.length*m;g.move(b,y);o.push(g);v+=l}var w=p*1;var E=p*.52;var S=p*1;var x=0;for(var m=0;m<o.length;m++){var g=o[m];var T=r+f;var N=i+2*f/o.length*m;for(var C=0;C<g.q.neighbors.length;C++){var k=r+f;var L=i+2*f/o.length*g.q.neighbors[C].dest.which;var A=(N+L)/2;var O=50;var M="M"+N+" "+T+" "+"S"+" "+A+" "+O+" "+L+" "+k;var _=paper.path(M);_.edge=g.q.neighbors[C];addCurveClickHandler(_);highlightCurve(_,false);g.q.neighbors[C].curve=_;x++}}jukeboxData.branchCount=x;return o}function addCurveClickHandler(e){e.click(function(){if(jukeboxData.selectedCurve){highlightCurve(jukeboxData.selectedCurve,false)}selectCurve(e,true);jukeboxData.selectedCurve=e});e.mouseover(function(){highlightCurve(e,true)});e.mouseout(function(){if(e!=jukeboxData.selectedCurve){highlightCurve(e,false)}})}function highlightCurve(e,t){if(e){if(t){e.attr("stroke-width",1.5);e.attr("stroke",highlightColor);e.attr("stroke-opacity",1);e.toFront()}else{if(e.edge){e.attr("stroke-width",1.5);e.attr("stroke",e.edge.src.tile.quantumColor);e.attr("stroke-opacity",1)}}}}function selectCurve(e){e.attr("stroke-width",1.5);e.attr("stroke",selectColor);e.attr("stroke-opacity",1);e.toFront()}function extractTitle(e){var t=e.lastIndexOf("/");if(t>=0&&t<e.length-1){var n=e.substring(t+1,e.length-4);return n}else{return e}}function getTitle(e,t,n){if(e==undefined||e.length==0||e==="(unknown title)"||e=="undefined"){if(n){e=extractTitle(n)}else{e=null}}else{if(t!=="(unknown artist)"){e=e+" by "+t}}return e}function loadTrack(e){fetchAnalysis(e)}function trackReady(e){e.fixedTitle=getTitle(e.title,e.artist,e.info.url);document.title="Pathways for "+e.fixedTitle;$("#song-title").text(e.fixedTitle);jukeboxData.minLongBranch=track.analysis.beats.length/5}function readyToPlay(e){setDisplayMode(true);driver=Driver(player);info("Ready to play!");normalizeColor();trackReady(e);drawVisualization()}function drawVisualization(){if(track){if(jukeboxData.currentThreshold==0){dynamicCalculateNearestNeighbors("beats")}else{calculateNearestNeighbors("beats",jukeboxData.currentThreshold)}createTilePanel("beats")}}function gotTheAnalysis(e){var t=get_status(e);if(t=="complete"){info("Loading track ...");remixer.remixTrack(e.response.track,function(e,t,n){track=t;if(isNaN(n)){n=0}if(e==1){info("Calculating pathways through the song ...");setTimeout(function(){readyToPlay(t)},10)}else if(e==0){if(n>=99){info("Calculating pathways through the song ...")}else{if(n>0){info(n+"% of track loaded ")}else{info("Loading the track ")}}}else{info("Trouble  "+t.status);setDisplayMode(false)}})}else if(t=="error"){info("Sorry, couldn't analyze that track");setDisplayMode(false)}}function listSong(e){var t=getTitle(e.title,e.artist,null);var n=null;if(t){var n=$("<li>").append(t);n.attr("class","song-link");n.click(function(){showPlotPage(e.id)})}return n}function listSongAsAnchor(e){var t=getTitle(e.title,e.artist,e.url);var n=$("<li>").html('<a href="index.html?trid='+e.id+'">'+t+"</a>");return n}function listTracks(e,t){$("#song-div").show();$("#song-list").empty();$(".sel-list").removeClass("activated");$(e).addClass("activated");for(var n=0;n<t.length;n++){var r=t[n];var i=listSong(r);if(i){$("#song-list").append(listSong(r))}}}function listPopularTracks(){listTracks("#popular-list",songs);ga_track("list","popular-tracks","")}function listRecentTracks(){$.getJSON("recent_tracks",{count:30},function(e){listTracks("#recent-list",e);ga_track("list","recent-tracks","")})}function listTopUploadedTracks(){listTracks("#upload-list",topUploadedSongs);ga_track("list","top-uploaded","")}function analyzeAudio(e,t,n){var r="http://labs.echonest.com/Uploader/qanalyze?callback=?";$.getJSON(r,{url:e,tag:t},function(r){if(r.status==="done"||r.status==="error"){n(r)}else{info(r.status+" - ready in about "+r.estimated_wait+" secs. ");setTimeout(function(){analyzeAudio(e,t,n)},5e3)}})}function noCache(){return{noCache:now()}}function fetchAnalysis(e){var t="http://static.echonest.com/infinite_jukebox_data/"+e+".json";info("Fetching the analysis");$.getJSON(t,function(e){gotTheAnalysis(e)}).error(function(){info("Sorry, can't find info for that track")})}function get_status(e){if(e.response.status.code==0){return e.response.track.status}else{return"error"}}function calculateDim(e,t,n){var r=t*n;var i=r/(1.2*e);var s=Math.floor(Math.sqrt(i));return s}function get_seg_distances(e,t){var n=seg_distance(e,t,"timbre",true);var r=seg_distance(e,t,"pitches");var i=Math.abs(e.loudness_start-t.loudness_start);var s=Math.abs(e.loudness_max-t.loudness_max);var o=Math.abs(e.duration-t.duration);var u=Math.abs(e.confidence-t.confidence);var a=n*timbreWeight+r*pitchWeight+i*loudStartWeight+s*loudMaxWeight+o*durationWeight+u*confidenceWeight;return a}function dynamicCalculateNearestNeighbors(e){var t=0;var n=track.analysis[e].length/6;precalculateNearestNeighbors(e,jukeboxData.maxBranches,jukeboxData.maxBranchThreshold);for(var r=10;r<jukeboxData.maxBranchThreshold;r+=5){t=collectNearestNeighbors(e,r);if(t>=n){break}}jukeboxData.currentThreshold=jukeboxData.computedThreshold=r;postProcessNearestNeighbors(e);return t}function postProcessNearestNeighbors(e){removeDeletedEdges();if(jukeboxData.addLastEdge){if(longestBackwardBranch(e)<50){insertBestBackwardBranch(e,jukeboxData.currentThreshold,65)}else{insertBestBackwardBranch(e,jukeboxData.currentThreshold,55)}}calculateReachability(e);jukeboxData.lastBranchPoint=findBestLastBeat(e);filterOutBadBranches(e,jukeboxData.lastBranchPoint);if(jukeboxData.removeSequentialBranches){filterOutSequentialBranches(e)}setTunedURL()}function removeDeletedEdges(){for(var e=0;e<jukeboxData.deletedEdges.length;e++){var t=jukeboxData.deletedEdges[e];if(t in jukeboxData.allEdges){var n=jukeboxData.allEdges[t];deleteEdge(n)}}jukeboxData.deletedEdges=[]}function getAllDeletedEdgeIDs(){var e=[];for(var t=0;t<jukeboxData.allEdges.length;t++){var n=jukeboxData.allEdges[t];if(n.deleted){e.push(n.id)}}return e}function getDeletedEdgeString(){var e=getAllDeletedEdgeIDs();if(e.length>0){return"&d="+e.join(",")}else{return""}}function calculateNearestNeighbors(e,t){precalculateNearestNeighbors(e,jukeboxData.maxBranches,jukeboxData.maxBranchThreshold);count=collectNearestNeighbors(e,t);postProcessNearestNeighbors(e,t);return count}function resetTuning(){undeleteAllEdges();jukeboxData.addLastEdge=true;jukeboxData.justBackwards=false;jukeboxData.justLongBranches=false;jukeboxData.removeSequentialBranches=false;jukeboxData.currentThreshold=jukeboxData.computedThreshold;jukeboxData.minRandomBranchChance=defaultMinRandomBranchChance;jukeboxData.maxRandomBranchChance=defaultMaxRandomBranchChance;jukeboxData.randomBranchChanceDelta=defaultRandomBranchChanceDelta,jukeboxData.minRandomBranchChance=defaultMinRandomBranchChance;jukeboxData.maxRandomBranchChance=defaultMaxRandomBranchChance;jukeboxData.randomBranchChanceDelta=defaultRandomBranchChanceDelta;drawVisualization()}function undeleteAllEdges(){jukeboxData.deletedEdgeCount=0;for(var e=0;e<jukeboxData.allEdges.length;e++){var t=jukeboxData.allEdges[e];if(t.deleted){t.deleted=false}}}function setTunedURL(){if(track){var e=getDeletedEdgeString();var t=false;var n="";if(!jukeboxData.addLastEdge){n="&lb=0"}var r="?trid="+track.id+e+n;if(jukeboxData.justBackwards){r+="&jb=1"}if(jukeboxData.justLongBranches){r+="&lg=1"}if(jukeboxData.removeSequentialBranches){r+="&sq=0"}if(jukeboxData.currentThreshold!=jukeboxData.computedThreshold){r+="&thresh="+jukeboxData.currentThreshold}if(jukeboxData.minRandomBranchChance!=defaultMinRandomBranchChance){t=true}if(jukeboxData.maxRandomBranchChance!=defaultMaxRandomBranchChance){t=true}if(jukeboxData.randomBranchChanceDelta!=defaultRandomBranchChanceDelta){t=true}if(t){r+="&bp="+[Math.round(map_value_to_percent(jukeboxData.minRandomBranchChance,0,1)),Math.round(map_value_to_percent(jukeboxData.maxRandomBranchChance,0,1)),Math.round(map_value_to_percent(jukeboxData.randomBranchChanceDelta,minRandomBranchChanceDelta,maxRandomBranchChanceDelta))].join(",")}history.replaceState({},document.title,r)}}function now(){return(new Date).getTime()}function longestBackwardBranch(e){var t=0;var n=track.analysis[e];for(var r=0;r<n.length;r++){var i=n[r];for(var s=0;s<i.neighbors.length;s++){var o=i.neighbors[s];var u=o.dest.which;var a=r-u;if(a>t){t=a}}}var f=t*100/n.length;return f}function insertBestBackwardBranch(e,t,n){var r=false;var i=[];var s=track.analysis[e];for(var o=0;o<s.length;o++){var u=s[o];for(var a=0;a<u.all_neighbors.length;a++){var f=u.all_neighbors[a];if(f.deleted){continue}var l=f.dest.which;var c=f.distance;var h=o-l;if(h>0&&c<n){var p=h*100/s.length;var d=[p,o,l,u,f];i.push(d)}}}if(i.length===0){return}i.sort(function(e,t){return e[0]-t[0]});i.reverse();var v=i[0];var m=v[3];var g=v[4];var y=g.distance;if(y>t){m.neighbors.push(g)}else{}}function calculateReachability(e){var t=1e3;var n=0;var r=track.analysis[e];for(var i=0;i<r.length;i++){var s=r[i];s.reach=r.length-s.which}for(n=0;n<t;n++){var o=0;for(i=0;i<r.length;i++){var s=r[i];var u=false;for(var a=0;a<s.neighbors.length;a++){var f=s.neighbors[a].dest;if(f.reach>s.reach){s.reach=f.reach;u=true}}if(i<r.length-1){var f=r[i+1];if(f.reach>s.reach){s.reach=f.reach;u=true}}if(u){o++;for(var l=0;l<s.which;l++){var f=r[l];if(f.reach<s.reach){f.reach=s.reach}}}}if(o==0){break}}if(false){for(var i=0;i<r.length;i++){var s=r[i];console.log(s.which,s.reach,Math.round(s.reach*100/r.length))}}}function map_percent_to_range(e,t,n){e=clamp(e,0,100);return(n-t)*e/100+t}function map_value_to_percent(e,t,n){e=clamp(e,t,n);return 100*(e-t)/(n-t)}function clamp(e,t,n){return e<t?t:e>n?n:e}function findBestLastBeat(e){var t=50;var n=track.analysis[e];var r=0;var i=0;for(var s=n.length-1;s>=0;s--){var o=n[s];var u=n.length-s;var a=(o.reach-u)*100/n.length;if(a>i&&o.neighbors.length>0){i=a;r=s;if(a>=t){break}}}jukeboxData.totalBeats=n.length;jukeboxData.longestReach=i;return r}function filterOutBadBranches(e,t){var n=track.analysis[e];for(var r=0;r<t;r++){var i=n[r];var s=[];for(var o=0;o<i.neighbors.length;o++){var u=i.neighbors[o];if(u.dest.which<t){s.push(u)}else{}}i.neighbors=s}}function hasSequentialBranch(e,t){var n=e.prev;if(n){var r=e.which-t.dest.which;for(var i=0;i<n.neighbors.length;i++){var s=n.which-n.neighbors[i].dest.which;if(r==s){return true}}}return false}function filterOutSequentialBranches(e){var t=track.analysis[e];for(var n=t.length-1;n>=1;n--){var r=t[n];var i=[];for(var s=0;s<r.neighbors.length;s++){var o=r.neighbors[s];if(hasSequentialBranch(r,o)){}else{i.push(o)}}r.neighbors=i}}function calculateNearestNeighborsForQuantum(e,t,n,r){var i=[];var s=0;for(var o=0;o<track.analysis[e].length;o++){if(o===r.which){continue}var u=track.analysis[e][o];var a=0;for(var f=0;f<r.overlappingSegments.length;f++){var l=r.overlappingSegments[f];var c=100;if(f<u.overlappingSegments.length){var h=u.overlappingSegments[f];if(l.which===h.which){c=100}else{c=get_seg_distances(l,h)}}a+=c}var p=r.indexInParent==u.indexInParent?0:100;var d=a/r.overlappingSegments.length+p;if(d<n){var v={id:s,src:r,dest:u,distance:d,curve:null,deleted:false};i.push(v);s++}}i.sort(function(e,t){if(e.distance>t.distance){return 1}else if(t.distance>e.distance){return-1}else{return 0}});r.all_neighbors=[];for(o=0;o<t&&o<i.length;o++){var v=i[o];r.all_neighbors.push(v);v.id=jukeboxData.allEdges.length;jukeboxData.allEdges.push(v)}}function precalculateNearestNeighbors(e,t,n){if("all_neighbors"in track.analysis[e][0]){return}jukeboxData.allEdges=[];for(var r=0;r<track.analysis[e].length;r++){var i=track.analysis[e][r];calculateNearestNeighborsForQuantum(e,t,n,i)}}function collectNearestNeighbors(e,t){var n=0;for(var r=0;r<track.analysis[e].length;r++){var i=track.analysis[e][r];i.neighbors=extractNearestNeighbors(i,t);if(i.neighbors.length>0){n+=1}}return n}function extractNearestNeighbors(e,t){var n=[];for(var r=0;r<e.all_neighbors.length;r++){var i=e.all_neighbors[r];if(i.deleted){continue}if(jukeboxData.justBackwards&&i.dest.which>e.which){continue}if(jukeboxData.justLongBranches&&Math.abs(i.dest.which-e.which)<jukeboxData.minLongBranch){continue}var s=i.distance;if(s<=t){n.push(i)}}return n}function seg_distance(e,t,n,r){if(r){return weighted_euclidean_distance(e[n],t[n])}else{return euclidean_distance(e[n],t[n])}}function calcBranchInfo(e){var t={};var n=0;for(var r=0;r<track.analysis[e].length;r++){var i=track.analysis[e][r];for(var s=0;s<i.neighbors.length;s++){var o=i.neighbors[s];var u=o.distance;var a=Math.round(u/10);if(!(a in t)){t[a]=0}t[a]+=1;n+=1}}console.log(t);console.log("total branches",n)}function euclidean_distance(e,t){var n=0;for(var r=0;r<e.length;r++){var i=t[r]-e[r];n+=i*i}return Math.sqrt(n)}function weighted_euclidean_distance(e,t){var n=0;for(var r=0;r<e.length;r++){var i=t[r]-e[r];var s=1;n+=i*i*s}return Math.sqrt(n)}function highlightCurves(e,t){for(var n=0;n<e.q.neighbors.length;n++){var r=e.q.neighbors[n].curve;highlightCurve(r,t);if(driver.isRunning()){break}}}function getQuantumColor(e){if(isSegment(e)){return getSegmentColor(e)}else{e=getQuantumSegment(e);if(e!=null){return getSegmentColor(e)}else{return"#000"}}}function getQuantumSegment(e){return e.oseg}function isSegment(e){return"timbre"in e}function getBranchColor(e){if(e.neighbors.length==0){return to_rgb(0,0,0)}else{var t=e.neighbors.length/jukeboxData.maxBranches;var n=to_rgb(t,0,1-t);return n}}function createNewTile(e,t,n,r){var i=0;var s=Object.create(tilePrototype);s.which=e;s.width=r;s.height=n;s.branchColor=getBranchColor(t);s.quantumColor=getQuantumColor(t);s.normalColor=s.quantumColor;s.isPlaying=false;s.isScaled=false;s.rect=paper.rect(0,0,s.width,s.height);s.rect.attr("stroke",s.normalColor);s.q=t;s.init();t.tile=s;s.normal();return s}function createTilePanel(e){removeAllTiles();jukeboxData.tiles=createTiles(e)}function normalizeColor(){cmin=[100,100,100];cmax=[-100,-100,-100];var e=track.analysis.segments;for(var t=0;t<e.length;t++){for(var n=0;n<3;n++){var r=e[t].timbre[n];if(r<cmin[n]){cmin[n]=r}if(r>cmax[n]){cmax[n]=r}}}}function getSegmentColor(e){var t=[];for(var n=0;n<3;n++){var r=e.timbre[n];var i=(r-cmin[n])/(cmax[n]-cmin[n]);t[n]=i*255;t[n]=i}return to_rgb(t[0],t[1],t[2])}function convert(e){var t=Math.round(e);var n=Number(t).toString(16);return n.length==1?"0"+n:n}function to_rgb(e,t,n){return"#"+convert(e*255)+convert(t*255)+convert(n*255)}function removeAllTiles(){for(var e=0;e<jukeboxData.tiles.length;e++){jukeboxData.tiles[e].rect.remove()}jukeboxData.tiles=[]}function deleteEdge(e){if(!e.deleted){jukeboxData.deletedEdgeCount++;e.deleted=true;if(e.curve){e.curve.remove();e.curve=null}for(var t=0;t<e.src.neighbors.length;t++){var n=e.src.neighbors[t];if(e==n){e.src.neighbors.splice(t,1);break}}}}function keydown(e){if(!$("#running").is(":visible")){return}if(e.which==39){var t=driver.getIncr();driver.setIncr(t+1);e.preventDefault()}if(e.which==8||e.which==46){e.preventDefault();if(jukeboxData.selectedCurve){deleteEdge(jukeboxData.selectedCurve.edge);jukeboxData.selectedCurve=null;drawVisualization()}}if(e.which==37){e.preventDefault();var t=driver.getIncr();driver.setIncr(t-1)}if(e.which==38){driver.setIncr(1);e.preventDefault()}if(e.which==40){driver.setIncr(0);e.preventDefault()}if(e.which==17){controlled=true}if(e.which==72){jukeboxData.infiniteMode=!jukeboxData.infiniteMode;if(jukeboxData.infiniteMode){info("Infinite Mode enabled");ga_track("main","infinite-mode","")}else{info("Bringing it on home");ga_track("main","home","")}}if(e.which==16){shifted=true}if(e.which==32){e.preventDefault();if(driver.isRunning()){driver.stop();ga_track("main","key-stop","")}else{driver.start();ga_track("main","key-start","")}}}function isDigit(e){return e>=48&&e<=57}function keyup(e){if(e.which==17){controlled=false}if(e.which==16){shifted=false}}function searchForTrack(){console.log("search for a track");var e=$("#search-text").val();console.log(e);if(e.length>0){var t="search";$.getJSON(t,{q:e,results:30},function(e){console.log(e);for(var t=0;t<e.length;t++){e[t].id=e[t].trid}listTracks("#search-list",e)})}}function init(){window.oncontextmenu=function(e){e.preventDefault();e.stopPropagation();return false};document.ondblclick=function(t){t.preventDefault();t.stopPropagation();return false};$(document).keydown(keydown);$(document).keyup(keyup);paper=Raphael("tiles",W,H);$("#error").hide();$("#load").click(function(){ga_track("main","load","");if(!uploadingAllowed){alert("Sorry, uploading is temporarily disabled, while we are under heavy load")}else{location.href="loader.html"}});$("#go").click(function(){if(driver.isRunning()){driver.stop();ga_track("main","stop",track.id)}else{driver.start();ga_track("main","start",track.id)}});$("#search").click(searchForTrack);$("#search-text").keyup(function(e){if(e.keyCode==13){searchForTrack()}});$("#new").click(function(){location.href="/"});$("#tune").click(function(){var e=$("#controls");e.dialog("open");ga_track("main","tune","")});$("#controls").attr("visibility","visible");$("#controls").dialog({autoOpen:false,title:"Fine tune your endless song",width:350,position:[4,4],resizable:false});$("#reset-edges").click(function(){resetTuning();ga_track("main","reset","")});$("#last-branch").change(function(e){if(e.originalEvent){jukeboxData.addLastEdge=$("#last-branch").is(":checked");drawVisualization()}});$("#reverse-branch").change(function(e){if(e.originalEvent){jukeboxData.justBackwards=$("#reverse-branch").is(":checked");drawVisualization()}});$("#long-branch").change(function(e){if(e.originalEvent){jukeboxData.justLongBranches=$("#long-branch").is(":checked");drawVisualization()}});$("#sequential-branch").change(function(e){if(e.originalEvent){jukeboxData.removeSequentialBranches=$("#sequential-branch").is(":checked");drawVisualization()}});$("#threshold-slider").slider({max:80,min:2,step:1,value:30,change:function(e,t){if(e.originalEvent){jukeboxData.currentThreshold=t.value;drawVisualization()}},slide:function(e,t){if(e.originalEvent){jukeboxData.currentThreshold=t.value}}});$("#probability-slider").slider({max:100,min:0,range:true,step:1,values:[Math.round(defaultMinRandomBranchChance*100),Math.round(defaultMaxRandomBranchChance*100)],change:function(e,t){if(e.originalEvent){jukeboxData.minRandomBranchChance=t.values[0]/100;jukeboxData.maxRandomBranchChance=t.values[1]/100;setTunedURL()}},slide:function(e,t){if(e.originalEvent){jukeboxData.minRandomBranchChance=t.values[0]/100;jukeboxData.maxRandomBranchChance=t.values[1]/100}}});$("#probability-ramp-slider").slider({max:100,min:0,step:2,value:30,change:function(e,t){if(e.originalEvent){jukeboxData.randomBranchChanceDelta=map_percent_to_range(t.value,minRandomBranchChanceDelta,maxRandomBranchChanceDelta);setTunedURL()}},slide:function(e,t){if(e.originalEvent){jukeboxData.randomBranchChanceDelta=map_percent_to_range(t.value,minRandomBranchChanceDelta,maxRandomBranchChanceDelta)}}});watch(jukeboxData,"addLastEdge",function(){$("#last-branch").attr("checked",jukeboxData.addLastEdge);setTunedURL()});watch(jukeboxData,"justBackwards",function(){$("#reverse-branch").attr("checked",jukeboxData.justBackwards);setTunedURL()});watch(jukeboxData,"justLongBranches",function(){$("#long-branch").attr("checked",jukeboxData.justLongBranches);setTunedURL()});watch(jukeboxData,"removeSequentialBranches",function(){$("#sequential-branch").attr("checked",jukeboxData.removeSequentialBranches);setTunedURL()});watch(jukeboxData,"currentThreshold",function(){$("#threshold").text(jukeboxData.currentThreshold);$("#threshold-slider").slider("value",jukeboxData.currentThreshold)});watch(jukeboxData,"lastThreshold",function(){$("#last-threshold").text(Math.round(jukeboxData.lastThreshold))});watch(jukeboxData,"minRandomBranchChance",function(){$("#min-prob").text(Math.round(jukeboxData.minRandomBranchChance*100));$("#probability-slider").slider("values",[jukeboxData.minRandomBranchChance*100,jukeboxData.maxRandomBranchChance*100]);jukeboxData.curRandomBranchChance=clamp(jukeboxData.curRandomBranchChance,jukeboxData.minRandomBranchChance,jukeboxData.maxRandomBranchChance)});watch(jukeboxData,"maxRandomBranchChance",function(){$("#max-prob").text(Math.round(jukeboxData.maxRandomBranchChance*100));$("#probability-slider").slider("values",[jukeboxData.minRandomBranchChance*100,jukeboxData.maxRandomBranchChance*100]);jukeboxData.curRandomBranchChance=clamp(jukeboxData.curRandomBranchChance,jukeboxData.minRandomBranchChance,jukeboxData.maxRandomBranchChance)});watch(jukeboxData,"curRandomBranchChance",function(){$("#branch-chance").text(Math.round(jukeboxData.curRandomBranchChance*100))});watch(jukeboxData,"randomBranchChanceDelta",function(){var e=Math.round(map_value_to_percent(jukeboxData.randomBranchChanceDelta,minRandomBranchChanceDelta,maxRandomBranchChanceDelta));$("#ramp-speed").text(e);$("#probabiltiy-ramp-slider").slider("value",e)});watch(jukeboxData,"totalBeats",function(){$("#total-beats").text(jukeboxData.totalBeats)});watch(jukeboxData,"branchCount",function(){$("#branch-count").text(jukeboxData.branchCount)});watch(jukeboxData,"deletedEdgeCount",function(){$("#deleted-branches").text(jukeboxData.deletedEdgeCount)});watch(jukeboxData,"longestReach",function(){$("#loop-length-percent").text(Math.round(jukeboxData.longestReach));var e=Math.round(jukeboxData.longestReach*jukeboxData.totalBeats/100);$("#loop-length-beats").text(Math.round(e));$("#total-beats").text(jukeboxData.totalBeats)});$("#popular-list").click(listPopularTracks);$("#recent-list").click(listRecentTracks);$("#upload-list").click(listTopUploadedTracks);jukeboxData.minRandomBranchChance=defaultMinRandomBranchChance;jukeboxData.maxRandomBranchChance=defaultMaxRandomBranchChance;jukeboxData.randomBranchChanceDelta=defaultRandomBranchChanceDelta;var e=getAudioContext();if(e==null){error("Sorry, this app needs advanced web audio. Your browser doesn't"+" support it. Try the latest version of Chrome or Safari");hideAll()}else{remixer=createJRemixer(e,$);player=remixer.getPlayer();processParams()}}function getAudioContext(){var e=null;if(typeof AudioContext!=="undefined"){e=new AudioContext}else if(typeof webkitAudioContext!=="undefined"){e=new webkitAudioContext}return e}function Driver(e){function h(){if(t==null||t==undefined){return jukeboxData.tiles[0]}else{var i;if(shifted){if(s===null){s=t;o=0}if(o++%2===1){return d(s)}else{return s}}if(controlled){return t}else{if(s!=null){var u=s;s=null;return u}else{i=t.which+r}}if(i<0){return jukeboxData.tiles[0]}else if(i>=jukeboxData.tiles.length){n=null;e.stop()}else{return p(jukeboxData.tiles[i])}}}function p(e){if(e.q.neighbors.length==0){return e}else if(v(e.q)){var t=e.q.neighbors.shift();jukeboxData.lastThreshold=t.distance;e.q.neighbors.push(t);var n=t.dest.tile;return n}else{return e}}function d(e){if(e.q.neighbors.length==0){return e}else{var t=e.q.neighbors.shift();e.q.neighbors.push(t);var n=t.dest.tile;return n}}function v(e){if(jukeboxData.infiniteMode){if(e.which==jukeboxData.lastBranchPoint){return true}jukeboxData.curRandomBranchChance+=jukeboxData.randomBranchChanceDelta;if(jukeboxData.curRandomBranchChance>jukeboxData.maxRandomBranchChance){jukeboxData.curRandomBranchChance=jukeboxData.maxRandomBranchChance}var t=Math.random()<jukeboxData.curRandomBranchChance;if(t){jukeboxData.curRandomBranchChance=jukeboxData.minRandomBranchChance}return t}else{return false}}function m(){l.text(jukeboxData.beatsPlayed);c.text(secondsToTime((now()-y)/1e3))}function g(){if(t!==null&&t!==undefined){t.normal()}if(n){if(i!=null){t=i;i=null}else{t=n()}if(t!==null){var r=e.curTime();if(r>u){a++;if(a++>f&&windowHidden()){info("Sorry, can't play music properly in the background");b.stop();return}}else{a=0}u=e.play(u,t.q);var s=u-r;setTimeout(function(){g()},1e3*s-10);t.playStyle();jukeboxData.beatsPlayed+=1;m()}}else{if(t!=null){t.normal()}}}var t=null;var n=null;var r=1;var i=null;var s=null;var o=0;var u=0;var a=0;var f=4;var l=$("#beats");var c=$("#time");var y=0;var b={start:function(){jukeboxData.beatsPlayed=0;u=0;s=null;jukeboxData.infiniteMode=true;jukeboxData.curRandomBranchChance=jukeboxData.minRandomBranchChance;a=0;n=h;y=now();$("#go").text("Stop");error("");info("");g()},stop:function(){var i=now()-y;$("#go").text("Play");if(t){t.normal();t=null}n=null;s=null;r=1;e.stop()},isRunning:function(){return n!==null},getIncr:function(){return r},getCurTile:function(){return t},setIncr:function(e){r=e},setNextTile:function(e){i=e}};return b}function secondsToTime(e){e=Math.floor(e);var t=Math.floor(e/3600);e-=t*3600;var n=Math.floor(e/60);e-=n*60;if(t<10){t="0"+t}if(n<10){n="0"+n}if(e<10){e="0"+e}return t+":"+n+":"+e}function windowHidden(){return document.webkitHidden}function processParams(){var e={};var t=document.URL.split("?")[1];if(t!=undefined){t=t.split("&");for(var n=0;n<t.length;n++){var r=t[n].split("=");var i=r[0];var s=r[1];e[i]=s}}if("trid"in e){var o=e["trid"];var u=0;if("thresh"in e){jukeboxData.currentThreshold=parseInt(e["thresh"])}if("d"in e){var a=e["d"].split(",");for(var n=0;n<a.length;n++){var f=parseInt(a[n]);jukeboxData.deletedEdges.push(f)}}if("lb"in e){if(e["lb"]=="0"){jukeboxData.addLastEdge=true}}if("jb"in e){if(e["jb"]=="1"){jukeboxData.justBackwards=true}}if("lg"in e){if(e["lg"]=="1"){jukeboxData.justLongBranches=true}}if("sq"in e){if(e["sq"]=="0"){jukeboxData.removeSequentialBranches=true}}if("bp"in e){var l=e["bp"];var c=l.split(",");if(c.length===3){var h=parseInt(c[0]);var p=parseInt(c[1]);var d=parseInt(c[2]);jukeboxData.minRandomBranchChance=map_percent_to_range(h,0,1);jukeboxData.maxRandomBranchChance=map_percent_to_range(p,0,1);jukeboxData.randomBranchChanceDelta=map_percent_to_range(d,minRandomBranchChanceDelta,maxRandomBranchChanceDelta)}}setDisplayMode(true);fetchAnalysis(o)}else if("key"in e){var v="http://"+e["bucket"]+"/"+urldecode(e["key"]);info("analyzing audio");setDisplayMode(true);$("#select-track").hide();analyzeAudio(v,"tag",function(e){if(e.status==="done"){showPlotPage(e.trid)}else{info("Trouble analyzing that track "+e.message)}})}else{setDisplayMode(false)}}function showPlotPage(e){var t=location.protocol+"//"+location.host+location.pathname+"?trid="+e;location.href=t}function urldecode(e){return decodeURIComponent((e+"").replace(/\+/g,"%20"))}function endsWith(e,t){return e.indexOf(t,e.length-t.length)!==-1}function isTuned(e){return e.indexOf("&")>0}function ga_track(e,t,n){_gaq.push(["_trackEvent",e,t,n])}var remixer;var player;var driver;var track;var W=900,H=600;var paper;var defaultMinRandomBranchChance=.18;var defaultMaxRandomBranchChance=.5;var defaultRandomBranchChanceDelta=.012;var minRandomBranchChanceDelta=0;var maxRandomBranchChanceDelta=.1;var highlightColor="#00ff00";var selectColor="#ff0000";var uploadingAllowed=true;var debugMode=true;var shifted=false;var controlled=false;var jukeboxData={infiniteMode:true,maxBranches:4,maxBranchThreshold:80,computedThreshold:0,currentThreshold:0,addLastEdge:true,justBackwards:false,justLongBranches:false,removeSequentialBranches:false,deletedEdgeCount:0,lastBranchPoint:0,longestReach:0,beatsPlayed:0,totalBeats:0,branchCount:0,selectedTile:null,selectedCurve:null,tiles:[],allEdges:[],deletedEdges:[],minRandomBranchChance:0,maxRandomBranchChance:0,randomBranchChanceDelta:0,curRandomBranchChance:0,lastThreshold:0};if(typeof Object.create!=="function"){Object.create=function(e){var t=function(){};t.prototype=e;return new t}}var timbreWeight=1,pitchWeight=10,loudStartWeight=1,loudMaxWeight=1,durationWeight=100,confidenceWeight=1;var tilePrototype={normalColor:"#5f9",move:function(e,t){this.rect.attr({x:e,y:t});if(this.label){this.label.attr({x:e+2,y:t+8})}},rotate:function(e){var t=360*(e/(Math.PI*2));this.rect.transform("r"+t)},play:function(e){if(e||shifted){this.playStyle();player.play(0,this.q)}else if(controlled){this.queueStyle();player.queue(this.q)}else{this.selectStyle()}if(e){info("Selected tile "+this.q.which);jukeboxData.selectedTile=this}},selectStyle:function(){this.rect.attr("fill","#C9a")},queueStyle:function(){this.rect.attr("fill","#aFF")},pauseStyle:function(){this.rect.attr("fill","#F8F")},playStyle:function(){if(!this.isPlaying){this.isPlaying=true;if(!this.isScaled){this.rect.scale(1.5,1.5);this.isScaled=true}this.rect.toFront();this.rect.attr("fill",highlightColor);highlightCurves(this,true)}},normal:function(){this.rect.attr("fill",this.normalColor);if(this.isScaled){this.isScaled=false;this.rect.scale(1/1.5,1/1.5)}highlightCurves(this,false);this.isPlaying=false},init:function(){var e=this;this.rect.mouseover(function(t){e.playStyle();if(debugMode){if(e.q.which>jukeboxData.lastBranchPoint){$("#beats").text(e.q.which+" "+e.q.reach+"*")}else{var n=track.analysis.beats.length;var r=n-e.q.which;$("#beats").text(e.q.which+" "+e.q.reach+" "+Math.floor((e.q.reach-r)*100/n))}}t.preventDefault()});this.rect.mouseout(function(t){e.normal();t.preventDefault()});this.rect.mousedown(function(t){t.preventDefault();driver.setNextTile(e);if(!driver.isRunning()){driver.start()}if(controlled){driver.setIncr(0)}})}};window.onload=init